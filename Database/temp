zad.1 

SELECT c_name, SUM(o_totalprice) AS suma_zamowien FROM
customer JOIN orders ON (c_custkey = o_custkey)
JOIN nation ON (c_nationkey = n_nationkey)
JOIN region ON (n_regionkey = r_regionkey)
WHERE EXTRACT(year FROM o_orderdate)=1997
AND r_name='EUROPE'
GROUP BY c_custkey
HAVING SUM(o_totalprice) > 500000
ORDER BY c_name DESC;

zad. 2

WITH
    cust_suma AS (

    SELECT c_name, c_nationkey, SUM(o_totalprice) AS suma 
    FROM customer 
    JOIN orders ON (c_custkey = o_custkey)
    WHERE EXTRACT(year FROM o_orderdate) = 1997
    GROUP BY c_custkey
    ),

    nat_max_sum AS (

    SELECT n_name, MAX(suma) AS maks
    FROM nation 
    LEFT JOIN cust_suma ON (cust_suma.c_nationkey = nation.n_nationkey)
    GROUP BY n_nationkey
    )

SELECT n_name, c_name, maks
FROM nat_max_sum LEFT JOIN
cust_suma ON nat_max_sum.maks = cust_suma.suma;

